<html>

<head>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
  
  <canvas>
  </canvas>
  
</body>

<script type='application/javascript' src="pacman.js"></script>
<script type='application/javascript' src="borderTemplate.js"></script>
<script type='application/javascript' src="border.js"></script>
<script type='application/javascript' src="ghost.js"></script>
<script type='application/javascript' src="maze.js"></script>
<script type='application/javascript' src="game.js"></script>
<script type='application/javascript' src="pill.js"></script>
<script type='application/javascript' src="food.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script><script>

$(document).ready( function() {
  
  var conf = { resolution: { x: 504, y: 558, fx: 28, fy: 31 },
               borderTemplates: borderTemplates()
             };
            
  var boardA = boardArray(); 
  var board = makeBoard(conf.borderTemplates);
  var state = {
                score: 0,
                gameState: 0, // 0 - before start, 1 - in game, 2 - game over
                maze: new maze( board ),
                board: boardA
              };
  
  // access the dom
  var canvas = $('canvas')[0];
  canvas.width = conf.resolution.x;
  canvas.height = conf.resolution.y;
  var ctx = canvas.getContext('2d');
  
  // set up events
  state.drawId = setInterval( function() { draw(conf, state, ctx); } , 1000 / 60 );
  
  $(document).keydown( function(ev) {
    console.log(ev.keyCode);
    console.log("pacman location: " + JSON.stringify(state.maze.pacman.loc));
    // check what's in next cell
    var next_loc = getNextCellLocation(state.maze.pacman, state.board, ev.keyCode);
    // get what is in next cell
    // perform event
    state = performEvent(next_loc, state);
  }); 
  
  function performEvent(next_loc, state) {
    switch(state.board[next_loc.y][next_loc.x])
    {
      // empty
      case 0: {
        // move pacman to this cell, i.e. change two board array cell values
        // and update pacman state
        var pac = state.maze.pacman;
        state.board[pac.loc.y][pac.loc.x] = 0;
        state.board[next_loc.y][next_loc.x] = 13;
        console.log("pacman loc before "+ JSON.stringify(pac.loc));
        // and update pacman in JSON
        state.maze.pacman.loc = next_loc;
        console.log("pacman loc after "+ JSON.stringify(pac.loc));
        break;
      }
      // pill
      case 7: {
        // remove pill from JSON, i.e. from state.maze.pills
        console.log("before removing pill")
        console.log(state.maze.pills.length)
        removeElemInJSON(next_loc, state.maze.pills);
        console.log("after removing pill")
        console.log(state.maze.pills.length)
        // increase score
        state.score++;
        // move pacman to this cell, i.e. change two board array cell values
        // and update pacman state
        var pac = state.maze.pacman;
        state.board[pac.loc.y][pac.loc.x] = 0;
        state.board[next_loc.y][next_loc.x] = 13;
        console.log("pacman loc before "+ JSON.stringify(pac.loc));
        // and update pacman in JSON
        state.maze.pacman.loc = next_loc;
        console.log("pacman loc after "+ JSON.stringify(pac.loc));
        break;
      }
      // food
      case 8: {
        // remove pill from JSON, i.e. from state.maze.pills
        console.log("before removing food")
        console.log(state.maze.food.length)
        removeElemInJSON(next_loc, state.maze.food);
        console.log("after removing food")
        console.log(state.maze.food.length)
        // increase score
        state.score += 10;
        // move pacman to this cell, i.e. change two board array cell values
        // and update pacman state
        var pac = state.maze.pacman;
        state.board[pac.loc.y][pac.loc.x] = 0;
        state.board[next_loc.y][next_loc.x] = 13;
        console.log("pacman loc before "+ JSON.stringify(pac.loc));
        // and update pacman in JSON
        state.maze.pacman.loc = next_loc;
        console.log("pacman loc after "+ JSON.stringify(pac.loc));
        break;
      }
      // border
      case 1:
      case 2:
      case 3:
      case 4:
      case 5:
      case 6: {
        console.log("bump");
        break;
      }
    }
    console.log("score: "+ state.score);
    return state;
  }
  
  function removeElemInJSON(loc, elems) {
    var i = elems.findIndex( function(el) { if ( el.loc.x == loc.x && el.loc.y == loc.y) return pill;});
    elems.splice(i, 1);
    //return pills;
  }
  
});

</script>
</html>